--source include/have_innodb.inc
--source include/master-slave.inc
--source include/have_debug.inc

--connection master
CALL mtr.add_suppression("Found 1 prepared XA transactions");
CALL mtr.add_suppression("Found 2 prepared XA transactions");
CREATE TABLE t ( f INT ) ENGINE=INNODB;
XA START 'xa1';
INSERT INTO t VALUES (20);
XA END 'xa1';
XA PREPARE 'xa1';
--sync_slave_with_master
--source include/stop_slave.inc

--connection master1
XA START 'xa2';
INSERT INTO t VALUES (30);
XA END 'xa2';
--exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
SET GLOBAL DEBUG_DBUG="d,simulate_crash_after_binlog_prepare";
--error 2013 # CR_SERVER_LOST
XA PREPARE 'xa2';

#
# Server restart
#
--enable_reconnect
--source include/wait_until_disconnected.inc
--let $rpl_server_number= 1
--source include/rpl_start_server.inc
--disable_reconnect

--connection slave
--source include/start_slave.inc

--connection master
SELECT * FROM t;
XA RECOVER;
XA COMMIT 'xa1';
XA COMMIT 'xa2';
SELECT * FROM t;
--sync_slave_with_master

SELECT * FROM t;

--connection master
DROP TABLE t;

--source include/rpl_end.inc
